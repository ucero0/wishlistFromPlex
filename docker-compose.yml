
services:
  db:
    image: postgres:15-alpine
    container_name: fastapi-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-plex_wishlist_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-plex_wishlist_pass}
      POSTGRES_DB: ${POSTGRES_DB:-plex_wishlist}
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-plex_wishlist_user} -d ${POSTGRES_DB:-plex_wishlist}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fastapi-network
    restart: unless-stopped

  fastapi:
    build: ./services/fastapi-app
    container_name: fastapi-app
    depends_on:
      db:
        condition: service_healthy
      antivirus:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-plex_wishlist_user}:${POSTGRES_PASSWORD:-plex_wishlist_pass}@db:5432/${POSTGRES_DB:-plex_wishlist}
      API_KEY: ${API_KEY}
      PLEX_SERVER_URL: ${PLEX_SERVER_URL:-http://plex:32400}
      PLEX_SYNC_INTERVAL_HOURS: ${PLEX_SYNC_INTERVAL_HOURS:-6}
      CONTAINER_PLEX_MEDIA_PATH: ${CONTAINER_PLEX_MEDIA_PATH}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # Deluge configuration - connects via gluetun container
      DELUGE_HOST: ${DELUGE_HOST}
      DELUGE_PORT: ${DELUGE_PORT}
      DELUGE_USERNAME: ${DELUGE_USERNAME}
      DELUGE_PASSWORD: ${DELUGE_PASSWORD}
      CONTAINER_DELUGE_QUARANTINE_PATH: ${CONTAINER_DELUGE_QUARANTINE_PATH}
      # Scanner configuration
      # ANTIVIRUS_DAEMON_HOST and ANTIVIRUS_DAEMON_PORT are for the antivirus daemon (port 3310)
      # ANTIVIRUS_HOST and ANTIVIRUS_PORT are for the HTTP scan service (port 3311)
      ANTIVIRUS_DAEMON_HOST: antivirus
      ANTIVIRUS_DAEMON_PORT: 3310
      ANTIVIRUS_HOST: antivirus
      ANTIVIRUS_PORT: 3311
      # Prowlarr configuration - connects via gluetun container
      PROWLARR_HOST: ${PROWLARR_HOST}
      PROWLARR_PORT: ${PROWLARR_PORT}
      PROWLARR_API_KEY: ${PROWLARR_API_KEY}
      # TMDB configuration
      TMDB_API_KEY: ${TMDB_API_KEY}


    ports:
      - "8000:8000"
    volumes:
      - ./services/fastapi-app/app:/app/app
      - ./services/fastapi-app/main.py:/app/main.py
      - ./services/fastapi-app/migrations:/app/migrations
      - delugeDownloadsQuarantine:${CONTAINER_DELUGE_QUARANTINE_PATH}
      - plexMedia:${CONTAINER_PLEX_MEDIA_PATH}
    networks:
      - fastapi-network
    restart: unless-stopped
    
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=nordvpn
      - VPN_TYPE=openvpn
      - NORDVPN_USER=${NORDVPN_USER}
      - NORDVPN_PASSWORD=${NORDVPN_PASSWORD}
      - OPENVPN_USER=${NORDVPN_USER}
      - OPENVPN_PASSWORD=${NORDVPN_PASSWORD}
      - HEALTH_SERVER_AUTH=no
      - HEALTH_SERVER_PORT=9999
      - SERVER_REGIONS=${SERVER_REGIONS:-}
      - FIREWALL=on
      - FIREWALL_INPUT_PORTS=8112,58846,${PROWLARR_PORT},8191
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12,172.18.0.0/16
      - FIREWALL_IPV6=off
    ports:
      - "8112:8112"
      - "${PROWLARR_PORT}:${PROWLARR_PORT}"
      - "8191:8191"
    volumes:
      - ./infra/gluetun:/gluetun
      - ./infra/gluetun/health-monitor-wrapper.sh:/health-monitor-wrapper.sh:ro
      - ./infra/gluetun/entrypoint-wrapper.sh:/entrypoint-wrapper.sh:ro
    entrypoint: ["/bin/sh", "/entrypoint-wrapper.sh"]
    networks:
      - fastapi-network
    healthcheck:
      # Check VPN connection status by verifying:
      # 1. OpenVPN process is running (process name is openvpn2.6, not openvpn)
      # 2. tun0 interface exists and has an IP address (VPN tunnel is established)
      # When AUTH_FAILED occurs, OpenVPN will exit and tun0 won't exist, making healthcheck fail
      # The health-monitor-wrapper.sh script runs alongside gluetun and exits the container
      # when it becomes unhealthy (after 3 consecutive failures), triggering Docker's restart policy
      test: ["CMD-SHELL", "pgrep openvpn > /dev/null && test -d /proc/sys/net/ipv4/conf/tun0 && ip addr show tun0 | grep -q 'inet ' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 2
      start_period: 10s
    restart: unless-stopped

  deluge:
    image: linuxserver/deluge:latest
    container_name: deluge
    network_mode: "service:gluetun"
    # Note: When using network_mode: service, containers share the network stack
    # When gluetun restarts, deluge will automatically restart too
    # We can't use condition: service_healthy with network_mode: service
    environment:
      - CONTAINER_DELUGE_QUARANTINE_PATH=${CONTAINER_DELUGE_QUARANTINE_PATH}
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - DELUGE_LOGLEVEL=info
      - API_KEY=${API_KEY}
      - SCANFORVIRUS_API_URL=${SCANFORVIRUS_API_URL}
    volumes:
      - ./infra/deluge/config:/config
      - delugeDownloadsQuarantine:${CONTAINER_DELUGE_QUARANTINE_PATH}
      - ./infra/deluge/custom-cont-init.d:/custom-cont-init.d:ro
      - ./infra/deluge/scripts:/scripts:ro
    depends_on:
      gluetun:
        condition: service_started
    restart: unless-stopped

  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    # Note: When using network_mode: service, containers share the network stack
    # When gluetun restarts, prowlarr will automatically restart too
    # We can't use condition: service_healthy with network_mode: service
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      # Authentication (set via config file after first setup)
      # To enable auth: Access UI, Settings → General → Security → Authentication
      # Set username/password, then API key will be generated
    volumes:
      - ./infra/prowlarr/config:/config
    depends_on:
      gluetun:
        condition: service_started
    restart: unless-stopped

  flaresolverr:
    image: flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    network_mode: "service:gluetun"
    # Note: When using network_mode: service, containers share the network stack
    # When gluetun restarts, flaresolverr will automatically restart too
    environment:
      - LOG_LEVEL=${FLARESOLVERR_LOG_LEVEL:-info}
      - TZ=Europe/Madrid
      - CAPTCHA_SOLVER=${FLARESOLVERR_CAPTCHA_SOLVER:-none}
    depends_on:
      gluetun:
        condition: service_started
    restart: unless-stopped

  plex:
    image: linuxserver/plex:latest
    container_name: plex
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
      - CONTAINER_PLEX_MEDIA_PATH=${CONTAINER_PLEX_MEDIA_PATH}
    volumes:
      - ./infra/plex/config:/config
      - plexMedia:${CONTAINER_PLEX_MEDIA_PATH}
    ports:
      - "32400:32400"
    networks:
      - fastapi-network
    restart: unless-stopped

  antivirus:
    image: clamav/clamav:latest  # Always use latest image for latest ClamAV version
    container_name: antivirus
    environment:
      - CLAMAV_NO_FRESHCLAMD=false
      - CLAMAV_NO_CLAMD=false
    volumes:
      - delugeDownloadsQuarantine:${CONTAINER_DELUGE_QUARANTINE_PATH}:rw  # Shared quarantine folder (read-write)
      - ./infra/antivirus/data:/var/lib/clamav
      - ./infra/antivirus/update-scripts:/update-scripts:ro
      - ./infra/antivirus/scan-service:/scan-service:ro
      - ./infra/antivirus/yara-rules:/yara-rules:rw  # Read-write for YARA rule updates
    healthcheck:
      # Check both services:
      # 1. Clamd daemon is responding on port 3310 (antivirus engine) - required
      # 2. HTTP scan service process is running (used by FastAPI) - required
      # The HTTP service listens on port 3311, but we check the process instead of the port
      # to avoid connection issues during healthcheck
      test: ["CMD-SHELL", "echo 'PING' | nc localhost 3310 | grep -q 'PONG' && pgrep -f 'http_scan_server.py' > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - fastapi-network
    restart: unless-stopped
    # Use custom startup script that installs dependencies and starts services
    # The startup script will then call the default /init entrypoint
    entrypoint: ["/bin/sh", "/scan-service/startup.sh"]

networks:
  fastapi-network:
    driver: bridge


volumes:
  plexMedia:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./infra/plex/media

  delugeDownloadsQuarantine:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./infra/deluge/downloads/quarantine

