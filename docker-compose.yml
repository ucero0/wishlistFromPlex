
services:
  db:
    image: postgres:15-alpine
    container_name: plex-wishlist-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-plex_wishlist_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-plex_wishlist_pass}
      POSTGRES_DB: ${POSTGRES_DB:-plex_wishlist}
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-plex_wishlist_user} -d ${POSTGRES_DB:-plex_wishlist}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - plex-wishlist-network

  fastapi:
    build: ./services/fastapi-app
    container_name: plex-wishlist-api
    depends_on:
      db:
        condition: service_healthy
      antivirus:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-plex_wishlist_user}:${POSTGRES_PASSWORD:-plex_wishlist_pass}@db:5432/${POSTGRES_DB:-plex_wishlist}
      API_KEY: ${API_KEY}
      PLEX_SERVER_URL: ${PLEX_SERVER_URL:-http://plex:32400}
      PLEX_SYNC_INTERVAL_HOURS: ${PLEX_SYNC_INTERVAL_HOURS:-6}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # Deluge configuration - connects via gluetun container
      DELUGE_HOST: ${DELUGE_HOST:-gluetun}
      DELUGE_PORT: ${DELUGE_PORT:-58846}
      DELUGE_USERNAME: ${DELUGE_USERNAME:-localclient}
      DELUGE_PASSWORD: ${DELUGE_PASSWORD:-}
      # Scanner configuration
      CLAMAV_HOST: antivirus
      CLAMAV_PORT: 3310
      YARA_RULES_PATH: /app/yara-rules
      # Prowlarr configuration - connects via gluetun container
      PROWLARR_HOST: ${PROWLARR_HOST:-gluetun}
      PROWLARR_PORT: ${PROWLARR_PORT:-9696}
      PROWLARR_API_KEY: ${PROWLARR_API_KEY:-}
    ports:
      - "8000:8000"
    volumes:
      - ./services/fastapi-app/app:/app/app
      - ./services/fastapi-app/main.py:/app/main.py
      - ./services/fastapi-app/migrations:/app/migrations
      - ./infra/deluge/downloads:/downloads
      - ./media:/media
      - ./media/quarantine:/media/quarantine  # Shared quarantine folder
      - ./yara-rules:/app/yara-rules:ro
    networks:
      - plex-wishlist-network
    restart: unless-stopped
    
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=nordvpn
      - VPN_TYPE=openvpn
      - NORDVPN_USER=${NORDVPN_USER}
      - NORDVPN_PASSWORD=${NORDVPN_PASSWORD}
      - OPENVPN_USER=${NORDVPN_USER}
      - OPENVPN_PASSWORD=${NORDVPN_PASSWORD}
      - HEALTH_SERVER_AUTH=no
      - SERVER_REGIONS=${SERVER_REGIONS:-}
      - FIREWALL=on
      - FIREWALL_INPUT_PORTS=8112,58846,9696,8191
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12,172.18.0.0/16
      - FIREWALL_IPV6=off
    ports:
      - "8112:8112"
      - "9696:9696"
      - "8191:8191"
    volumes:
      - ./infra/gluetun:/gluetun
    networks:
      - plex-wishlist-network
    restart: unless-stopped

  deluge:
    image: linuxserver/deluge:latest
    container_name: deluge
    network_mode: "service:gluetun"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - DELUGE_LOGLEVEL=info
      - API_KEY=${API_KEY}
      - SCANNER_API_URL=http://plex-wishlist-api:8000
    volumes:
      - ./infra/deluge/config:/config
      - ./infra/deluge/downloads:/downloads
      - ./infra/deluge/custom-cont-init.d:/custom-cont-init.d:ro
      - ./infra/deluge/scripts:/scripts:ro
    depends_on:
      - gluetun
    restart: unless-stopped

  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      # Authentication (set via config file after first setup)
      # To enable auth: Access UI, Settings → General → Security → Authentication
      # Set username/password, then API key will be generated
    volumes:
      - ./infra/prowlarr/config:/config
    depends_on:
      - gluetun
    restart: unless-stopped

  flaresolverr:
    image: flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    network_mode: "service:gluetun"
    environment:
      - LOG_LEVEL=${FLARESOLVERR_LOG_LEVEL:-info}
      - TZ=Europe/Madrid
      - CAPTCHA_SOLVER=${FLARESOLVERR_CAPTCHA_SOLVER:-none}
    depends_on:
      - gluetun
    restart: unless-stopped

  plex:
    image: linuxserver/plex:latest
    container_name: plex
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
    volumes:
      - ./infra/plex/config:/config
      - ./media/movies:/media/movies
      - ./media/tvshows:/media/tvshows
    ports:
      - "32400:32400"
    networks:
      - plex-wishlist-network
    restart: unless-stopped

  antivirus:
    image: clamav/clamav:latest  # Always use latest image for latest ClamAV version
    container_name: antivirus
    environment:
      - CLAMAV_NO_FRESHCLAMD=false
      - CLAMAV_NO_CLAMD=false
    volumes:
      - ./infra/clamav/data:/var/lib/clamav
      - ./infra/deluge/downloads:/scan/downloads:ro
      - ./media:/scan/media:ro
      - ./media/quarantine:/scan/quarantine:rw  # Shared quarantine folder (read-write)
      - ./infra/clamav/update-scripts:/update-scripts:ro
      - ./infra/clamav/scan-service:/scan-service:ro
      - ./yara-rules:/yara-rules:rw  # Read-write for YARA rule updates
    healthcheck:
      test: ["CMD", "clamdcheck.sh"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - plex-wishlist-network
    restart: unless-stopped
    # Use custom startup script that installs dependencies and starts services
    # The startup script will then call the default /init entrypoint
    entrypoint: ["/bin/sh", "/scan-service/startup.sh"]

networks:
  plex-wishlist-network:
    driver: bridge



